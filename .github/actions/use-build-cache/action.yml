name: Use build cache

description: Builds the Next.js app and caches the result

runs:
  using: 'composite'
  steps:
  # Caches the app's build files, breaks cache when the yarn.lock file or .js/.jsx files are updated
  - name: Cache build
    id: build-cache
    uses: actions/cache@v3
    with:
      path: |
        ${{ github.workspace }}/.next
      key: pr-${{ runner.os }}-nextjs-${{ hashFiles('**/.env') }}-${{ hashFiles('**/yarn.lock') }}-${{ hashFiles('**/*.[jt]s', '**/*.[jt]sx') }}

  # Builds the app if the cache was broken
  # NOTE: The .env file is added as a path to the build-cache so when
  # yarn build runs, it will have the proper environment variables
  - name: Build app
    if: steps.build-cache.outputs.cache-hit != 'true'
    run: yarn build
    shell: bash