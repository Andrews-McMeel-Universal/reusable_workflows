name: Purge Azure CDN

on:
  workflow_call:
    inputs:
      environment:
        required: false
        type: string
        description: "Deploy Environment. Can be development, staging, or production."
      cdnResourceGroup:
        required: false
        type: string
        description: "CDN Resource Group."
      cdnProfile:
        required: false
        type: string
        description: "CDN Profile."
      cdnEndpoint:
        required: false
        type: string
        description: "CDN Endpoint."
    secrets:
      azureCredentials:
        required: true

jobs:
  purge-cdn:
    name: Purge CDN Cache
    runs-on: ubuntu-latest
    steps:
      - name: Login via Az module
        uses: azure/login@v2
        with:
          creds: "${{ secrets.azureCredentials }}"
          enable-AzPSSession: true

      - name: Purge CDN cache
        shell: pwsh
        run: |
          if (-not ${{ inputs.cdnResourceGroup }}) {
            Write-Error "CDN Resource Group is required. Please provide the CDN Resource Group name when calling the workflow."
            exit 1
          }

          if (-not ${{ inputs.cdnProfile }}) {
            Write-Error "CDN Profile is required. Please provide the CDN Profile name when calling the workflow."
            exit 1
          }

          if (-not ${{ inputs.cdnEndpoint }}) {
            Write-Error "CDN Endpoint is required. Please provide the CDN Endpoint name when calling the workflow."
            exit 1
          }

          $ResourceGroup = "${{ inputs.cdnResourceGroup }}"
          $ProfileName = "${{ inputs.cdnProfile }}"
          $EndpointName = "${{ inputs.cdnEndpoint }}"

          Clear-AzCdnEndpointContent -EndpointName $EndpointName -ProfileName $ProfileName -ResourceGroupName $ResourceGroup -ContentPath '/*'
