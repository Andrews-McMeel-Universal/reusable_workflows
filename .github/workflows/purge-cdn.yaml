name: Purge Azure CDN

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
        description: "Deploy Environment. Can be development, staging, or production."
    secrets:
      azureCredentials:
        required: true

jobs:
  purge-cdn:
    name: Purge CDN Cache
    runs-on: ubuntu-latest
    steps:
      - name: Login via Az module
        uses: azure/login@v1.4.7
        with:
          creds: "${{ secrets.azureCredentials }}"
          enable-AzPSSession: true

      - name: Purge CDN cache
        uses: azure/powershell@v1.2.0
        with:
          azPSVersion: "latest"
          inlineScript: |
            $ProfileName = (Get-AzResource -ResourceType Microsoft.Cdn/profiles -Tag @{"environment"="${{ inputs.environment }}"}).Name
            $ResourceGroup = (Get-AzResource -ResourceType Microsoft.Cdn/profiles -Tag @{"environment"="${{ inputs.environment }}"}).ResourceGroupName
            $EndpointName = (Get-AzResource -ResourceType Microsoft.Cdn/profiles/endpoints -Tag @{"repository-name"="${{ github.event.repository.name }}"} | Where-Object { $_.Tags."environment" -contains "staging" }).Name -replace ("${ProfileName}/","")

            Clear-AzCdnEndpointContent -EndpointName $EndpointName -ProfileName $ProfileName -ResourceGroupName $ResourceGroup -ContentPath '/*'
