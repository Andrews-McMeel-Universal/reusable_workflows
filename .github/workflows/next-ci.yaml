name: Next.js Application CI

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      YARN_INSTALL:
        required: false
        type: string
        default: ${{ vars.APPLICATION_CI_YARN_INSTALL || 'false' }}
      RUN_PLAYWRIGHT_TESTS:
        required: false
        type: string
        default: ${{ vars.APPLICATION_CI_RUN_PLAYWRIGHT_TESTS || 'true' }}
      LINT_SCSS:
        required: false
        type: string
        default: ${{ vars.APPLICATION_CI_LINT_SCSS || 'true' }}
      LINT_JS:
        required: false
        type: string
        default: ${{ vars.APPLICATION_CI_LINT_JS || 'true' }}
      RUN_JEST_TESTS:
        required: false
        type: string
        default: ${{ vars.APPLICATION_CI_RUN_JEST_TESTS || 'true' }}
      GITHUB_RUNNER:
        required: false
        type: string
        description: "The type of runner to use"
        default: ${{ vars.CUSTOM_GITHUB_RUNNER || 'azure' }}
      COREPACK_INSTALL:
        required: false
        type: string
        default: ${{ vars.APPLICATION_CI_COREPACK_INSTALL || 'true' }}
      ENV_ENCRYPTION_SECRET:
        required: false
        type: string
        default: ${{ vars.ENV_ENCRYPTION_SECRET }}
      JIRA_AUTOMATIONS_EMAIL:
        required: false
        type: string
        default: ${{ vars.JIRA_AUTOMATIONS_EMAIL }}
      JIRA_AUTOMATIONS_DOMAIN:
        required: false
        type: string
        default: ${{ vars.JIRA_AUTOMATIONS_DOMAIN }}
    secrets:
      AZURE_CREDENTIALS:
        required: true
      PAT_ACTION_CI:
        required: true
      AMUTESTASSETS_STORAGEACCOUNTKEY:
        required: false
      JIRA_TOKEN:
        required: false

jobs:
  debug-changes:
    name: Debug Changed Files
    if: ${{ github.actor != 'dependabot[bot]' }}
    runs-on: ${{ inputs.GITHUB_RUNNER }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_ACTION_CI }}
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        shell: bash
        run: |
          IFS=$'\n\t'

          # Determine the range of commits to analyze
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BASE=${{ github.event.pull_request.base.sha }}
            HEAD=${{ github.event.pull_request.head.sha }}
          else
            # For pushes, GitHub provides before/after
            BASE="${{ github.event.before }}"
            HEAD="${{ github.sha }}"
            # Fallback if 'before' is empty (e.g., first push)
            if [[ -z "$BASE" ]]; then
              BASE="$(git rev-list -n 2 "$HEAD" | tail -n 1 || true)"
            fi
          fi

          # Initialize flags
          RUN_LINTER=false
          RUN_JEST=false
          RUN_PLAYWRIGHT=false

          echo "Files changed between $BASE and $HEAD:"
          while IFS= read -r -d '' FILE; do
            echo " - $FILE"

            # Lintable Files
            case "$FILE" in
              src/*|public/*|playwright/*|.storybook/*|**/*.json|**/*.scss|**/*.css|**/*.config.*)
                RUN_LINTER=true
                ;;
            esac

            # Jest Files
            case "$FILE" in
              src/*|*.js|*.jsx|*.ts|*.tsx|jest.config.*|**/jest.*|**/*.test.*|**/package.json|**/yarn.lock)
                RUN_JEST=true
                ;;
            esac

            # Playwright Files
            case "$FILE" in
              src/*|playwright/*|**/*.spec.ts|**/*.spec.tsx|playwright.*|**/package.json|**/yarn.lock)
                RUN_PLAYWRIGHT=true
                ;;
            esac

            # Content-based detection
            if [[ -f "$FILE" ]] && LC_ALL=C grep -Iq . -- "$FILE"; then
              if LC_ALL=C grep -Eiq -- '(^|[^A-Za-z])jest([^A-Za-z]|$)|@jest/|describe\(|it\(|test\(' "$FILE"; then
                RUN_JEST=true
              fi
              if LC_ALL=C grep -Eiq -- '(^|[^A-Za-z])playwright([^A-Za-z]|$)|@playwright/test' "$FILE"; then
                RUN_PLAYWRIGHT=true
              fi
            fi
          done < <(git diff --name-only -z "$BASE" "$HEAD")

          echo "---"
          echo "Determined actions to run:"
          echo "run-linter=$RUN_LINTER" >> "$GITHUB_OUTPUT"
          echo "run-linter=$RUN_LINTER"
          echo "run-jest=$RUN_JEST" >> "$GITHUB_OUTPUT"
          echo "run-jest=$RUN_JEST"
          echo "run-playwright=$RUN_PLAYWRIGHT" >> "$GITHUB_OUTPUT"
          echo "run-playwright=$RUN_PLAYWRIGHT"

    outputs:
      run-linter: ${{ steps.changed-files.outputs.run-linter }}
      run-jest: ${{ steps.changed-files.outputs.run-jest }}
      run-playwright: ${{ steps.changed-files.outputs.run-playwright }}

  build:
    name: Build App
    if: ${{ needs.debug-changes.outputs.run-linter == 'true' || needs.debug-changes.outputs.run-jest == 'true' || needs.debug-changes.outputs.run-playwright == 'true' }}
    runs-on: ${{ inputs.GITHUB_RUNNER }}
    needs: [debug-changes]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_ACTION_CI }}
          fetch-depth: 0

      - name: Use cache-next-install action
        if: ${{ inputs.YARN_INSTALL == 'false' }}
        uses: Andrews-McMeel-Universal/cache-next-install@v1

      - name: Use cache-yarn-install action
        if: ${{ inputs.YARN_INSTALL == 'true' }}
        uses: Andrews-McMeel-Universal/cache-yarn-install@v1
        with:
          enable-corepack: ${{ inputs.COREPACK_INSTALL }}

      - name: Lint javascript
        if: ${{ inputs.LINT_JS == 'true' }}
        run: yarn lint:js

      - name: Lint scss
        if: ${{ inputs.LINT_SCSS == 'true' }}
        run: yarn lint:styles

      - name: Push Linting Fixes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_user_name: amutechtest
          commit_user_email: amu_deploy@amuniversal.com
          commit_message: "[Formatter] Apply prettier changes"

      - name: Prepare environment encryption key
        id: env-enc-key
        run: |
          ENV_ENCRYPTION_SECRET="$(jq -r '.inputs.ENV_ENCRYPTION_SECRET' $GITHUB_EVENT_PATH | base64 --decode 2>/dev/null)"
          echo "::add-mask::${ENV_ENCRYPTION_SECRET}"
          echo "envEncryptionSecret=${ENV_ENCRYPTION_SECRET}" >> $GITHUB_OUTPUT

      - name: Use .env cache action
        uses: Andrews-McMeel-Universal/get-envs@v1
        with:
          azurecredentials: ${{ secrets.AZURE_CREDENTIALS }}
          environment: ${{ inputs.environment }}
          enableCaching: true
          envEncryptionSecret: ${{ steps.env-enc-key.outputs.envEncryptionSecret }}

      - name: Use cache-next-build action
        uses: Andrews-McMeel-Universal/cache-next-build@v1

  unit-tests:
    name: Unit Tests
    if: ${{ inputs.RUN_JEST_TESTS == 'true' && needs.debug-changes.outputs.run-jest == 'true' }}
    needs: [debug-changes,build]
    runs-on: ${{ inputs.GITHUB_RUNNER }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use cache-next-install action
        if: ${{ inputs.YARN_INSTALL == 'false' }}
        uses: Andrews-McMeel-Universal/cache-next-install@v1

      - name: Use cache-yarn-install action
        if: ${{ inputs.YARN_INSTALL == 'true' }}
        uses: Andrews-McMeel-Universal/cache-yarn-install@v1
        with:
          enable-corepack: ${{ inputs.COREPACK_INSTALL }}

      - name: Prepare environment encryption key
        id: env-enc-key
        run: |
          ENV_ENCRYPTION_SECRET="$(jq -r '.inputs.ENV_ENCRYPTION_SECRET' $GITHUB_EVENT_PATH | base64 --decode 2>/dev/null)"
          echo "::add-mask::${ENV_ENCRYPTION_SECRET}"
          echo "envEncryptionSecret=${ENV_ENCRYPTION_SECRET}" >> $GITHUB_OUTPUT

      - name: Use .env cache action
        uses: Andrews-McMeel-Universal/get-envs@v1
        with:
          azurecredentials: ${{ secrets.AZURE_CREDENTIALS }}
          environment: ${{ inputs.environment }}
          enableCaching: true
          envEncryptionSecret: ${{ steps.env-enc-key.outputs.envEncryptionSecret }}

      - name: Use cache-next-build action
        uses: Andrews-McMeel-Universal/cache-next-build@v1

      - name: Run Jest tests
        run: yarn test:unit:ci

  playwright-tests:
    name: Playwright Tests
    if: ${{ inputs.RUN_PLAYWRIGHT_TESTS == 'true' && needs.debug-changes.outputs.run-playwright == 'true' }}
    needs: [debug-changes,build]
    runs-on: ${{ inputs.GITHUB_RUNNER }}
    timeout-minutes: 25
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use cache-next-install action
        if: ${{ inputs.YARN_INSTALL == 'false' }}
        uses: Andrews-McMeel-Universal/cache-next-install@v1

      - name: Use cache-yarn-install action
        if: ${{ inputs.YARN_INSTALL == 'true' }}
        uses: Andrews-McMeel-Universal/cache-yarn-install@v1
        with:
          enable-corepack: ${{ inputs.COREPACK_INSTALL }}

      - name: Install Playwright Browsers
        run: yarn playwright install --with-deps

      - name: Prepare environment encryption key
        id: env-enc-key
        run: |
          ENV_ENCRYPTION_SECRET="$(jq -r '.inputs.ENV_ENCRYPTION_SECRET' $GITHUB_EVENT_PATH | base64 --decode 2>/dev/null)"
          echo "::add-mask::${ENV_ENCRYPTION_SECRET}"
          echo "envEncryptionSecret=${ENV_ENCRYPTION_SECRET}" >> $GITHUB_OUTPUT

      - name: Use .env cache action
        uses: Andrews-McMeel-Universal/get-envs@v1
        with:
          azurecredentials: ${{ secrets.AZURE_CREDENTIALS }}
          environment: ${{ inputs.environment }}
          enableCaching: true
          envEncryptionSecret: ${{ steps.env-enc-key.outputs.envEncryptionSecret }}

      - name: Use cache-next-build action
        uses: Andrews-McMeel-Universal/cache-next-build@v1

      - name: Run Playwright tests
        run: yarn test:integration:ci

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

      - name: Retrieve Jira Ticket Key
        id: retrieve-jira-ticket
        uses: Andrews-McMeel-Universal/retrieve-jira-ticket@v1

      - name: Sanitize repository name
        id: repo-name
        run: |
          REPO_NAME="${GITHUB_REPOSITORY##*/}"
          SANITIZED_REPO_NAME=$(echo "$REPO_NAME" | tr '[:upper:]' '[:lower:]' | tr -c 'a-z0-9-' '-' | sed 's/^-*//;s/-*$//;s/--*/-/g')
          echo "repo-name=${SANITIZED_REPO_NAME}" >> $GITHUB_OUTPUT

      - name: Upload Playwright Report to Azure Storage Account
        uses: azure/cli@v2
        with:
          inlineScript: |
            AZURE_STORAGE_CONNECTION_STRING="DefaultEndpointsProtocol=https;AccountName=amutestassets;AccountKey=${{ secrets.AMUTESTASSETS_STORAGEACCOUNTKEY }};EndpointSuffix=core.windows.net"
            CONTAINER_NAME="playwright-reports"
            SOURCE_DIR="playwright-report"
            DEST_PATH="${{ steps.repo-name.outputs.repo-name }}/${{ steps.retrieve-jira-ticket.outputs.jira-ticket-id }}/"

            # Upload files
            az storage blob upload-batch \
                --connection-string "${AZURE_STORAGE_CONNECTION_STRING}" \
                --destination "${CONTAINER_NAME}" \
                --source "${SOURCE_DIR}" \
                --destination-path "${DEST_PATH}" \
                --overwrite

      - name: Check if Playwright Jira Comment Exists
        id: check-jira-comments
        shell: pwsh
        run: |
          $uri = "https://${{ inputs.JIRA_AUTOMATIONS_DOMAIN }}.atlassian.net/rest/api/2/issue/${{ steps.retrieve-jira-ticket.outputs.jira-ticket-id }}"
          $username = "${{ inputs.JIRA_AUTOMATIONS_EMAIL }}"
          $token = "${{ secrets.JIRA_TOKEN }}"
          $base64AuthInfo = [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes(("{0}:{1}" -f $username,$token)))
          $headers = @{
              Authorization = ("Basic {0}" -f $base64AuthInfo)
              "Content-Type" = "application/json"
          }

          try {
              $response = Invoke-RestMethod -Headers $headers -Uri $uri -Method Get
              Write-Output "Ticket $ticket found."
          }
          catch {
              Write-Error "Exception occurred while fetching ticket: $_"
              exit 1
          }

          $comments = $response.fields.comment.comments
          foreach ($comment in $comments) {
              if ($comment.body -match "This ticket's Playwright Report:") {
                  Write-Output "comment-found=true" >> $env:GITHUB_OUTPUT
                  $commentFound = $true
                  break
              }
          }

      - name: Login to Jira
        if: ${{ steps.check-jira-comments.outputs.comment-found != 'true' }}
        uses: atlassian/gajira-login@v3
        env:
          JIRA_BASE_URL: https://${{ inputs.JIRA_AUTOMATIONS_DOMAIN }}.atlassian.net
          JIRA_USER_EMAIL: ${{ inputs.JIRA_AUTOMATIONS_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_TOKEN }}

      - name: Link ephemeral deployment in Jira ticket
        if: ${{ steps.check-jira-comments.outputs.comment-found != 'true' }}
        uses: atlassian/gajira-comment@v3
        with:
          issue: ${{ steps.retrieve-jira-ticket.outputs.jira-ticket-id }}
          comment: |
            This ticket's Playwright Report: [Playwright Report|https://amutestassets.blob.core.windows.net/playwright-reports/${{ steps.repo-name.outputs.repo-name }}/${{ steps.retrieve-jira-ticket.outputs.jira-ticket-id }}/index.html]
